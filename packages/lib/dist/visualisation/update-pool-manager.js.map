{"version":3,"file":"update-pool-manager.js","sourceRoot":"","sources":["../../src/visualisation/update-pool-manager.ts"],"names":[],"mappings":"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","sourcesContent":["import { scheduleOutsideOfZone } from '../zone-handler';\n\nexport interface PoolData<T> {\n\thit: number;\n\ttagName: string;\n\texpiration: number;\n\tdata: T;\n}\n\n// Duration of the rect being added\nconst DURATION = 250;\ndeclare const Zone;\n\nexport abstract class UpdatePoolManager<T> {\n\tpool = new Map<string, PoolData<T>>();\n\tdrawing = false;\n\tclearTimer;\n\n\taddAll(items: Map<string, any> | any) {\n\t\tfor (const [uuid, dataToAdd] of items.entries\n\t\t\t? items.entries()\n\t\t\t: Object.entries(items)) {\n\t\t\t// console.log('pool length', this.pool.size);\n\t\t\tlet data;\n\t\t\tif (this.pool.has(uuid)) {\n\t\t\t\tdata = this.pool.get(uuid);\n\t\t\t} else {\n\t\t\t\tdata = {\n\t\t\t\t\thit: 0,\n\t\t\t\t\ttagName: dataToAdd.tagName,\n\t\t\t\t\tdata: dataToAdd\n\t\t\t\t};\n\t\t\t}\n\n\t\t\t// console.log(data);\n\t\t\tdata = {\n\t\t\t\t...data,\n\t\t\t\texpiration: Date.now() + DURATION,\n\t\t\t\thit: data.hit + 1\n\t\t\t};\n\t\t\t// console.log(data);\n\n\t\t\tthis.pool.set(uuid, data);\n\t\t}\n\n\t\tthis.scheduleDraw();\n\t}\n\n\tadd(uuid: string, tagName: string, dataToAdd: T) {\n\t\tlet data;\n\t\tif (this.pool.has(uuid)) {\n\t\t\tdata = this.pool.get(uuid);\n\t\t} else {\n\t\t\tdata = {\n\t\t\t\thit: 0,\n\t\t\t\ttagName,\n\t\t\t\tdata: dataToAdd\n\t\t\t};\n\t\t}\n\n\t\tdata = {\n\t\t\t...data,\n\t\t\texpiration: Date.now() + DURATION,\n\t\t\thit: data.hit + 1\n\t\t};\n\n\t\tthis.pool = this.pool.set(uuid, data);\n\n\t\tthis.scheduleDraw();\n\t}\n\n\tfirstExpirationDate() {\n\t\tconst now = Date.now();\n\t\tlet minExpiration = Number.MAX_VALUE;\n\n\t\t// Calculate the 'nearest' expiration date\n\t\t// Remove all the ones that already expired\n\t\tconst temp = new Map<string, PoolData<T>>();\n\t\tfor (const [uuid, data] of this.pool.entries()) {\n\t\t\tif (data.expiration > now) {\n\t\t\t\tminExpiration = Math.min(data.expiration, minExpiration);\n\t\t\t\ttemp.set(uuid, data);\n\t\t\t}\n\t\t}\n\t\tthis.pool = temp;\n\t\treturn minExpiration;\n\t}\n\n\tdraw() {\n\t\tconst now = Date.now();\n\t\tconst minExpiration = this.firstExpirationDate();\n\n\t\tthis.drawImpl(this.pool);\n\n\t\tif (this.pool.size > 0) {\n\t\t\tif (this.clearTimer != null) {\n\t\t\t\tclearTimeout(this.clearTimer);\n\t\t\t}\n\t\t\tthis.clearTimer = setTimeout(this.redraw.bind(this), minExpiration - now);\n\t\t}\n\n\t\tthis.drawing = false;\n\t}\n\n\tprivate redraw() {\n\t\tthis.clearTimer = null;\n\t\tif (!this.drawing && this.pool.size > 0) {\n\t\t\tthis.drawing = true;\n\t\t\tthis.draw();\n\t\t}\n\t}\n\n\tprivate scheduleDraw() {\n\t\t// If we're already drawing, no use in setting a new event\n\t\tif (this.drawing) {\n\t\t\treturn;\n\t\t}\n\n\t\t// FIXME fix this shit\n\t\tthis.drawing = true;\n\t\t// Draw on the next animationFrame, use Zone to make sure it doesn't trigger a CD cycle in Angular\n\t\t// if (Zone) {\n\t\t//   Zone.root.run(() => {\n\t\trequestAnimationFrame(this.draw.bind(this));\n\t\t//   });\n\t\t// } else {\n\t\t// scheduleOutsideOfZone(() => requestAnimationFrame(this.draw.bind(this)));\n\t\t// }\n\t}\n\n\tabstract drawImpl(pool: Map<string, PoolData<T>>);\n}\n"]}